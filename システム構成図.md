# システム構成図（大規模システム技術仕様）

## 1. システム全体構成 - エンタープライズアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  クライアント層 (フロントエンド)               │
├─────────────────────────────────────────────────────────────┤
│ ┌───────────────────┐  ┌───────────────────┐  ┌────────────┐│
│ │    Webブラウザ     │  │   モバイルアプリ   │  │ タブレット ││
│ │  (アクセシブルUI)  │  │   (オプション)    │  │(オプション) ││
│ └─────────┬─────────┘  └─────────┬─────────┘  └─────┬──────┘│
└───────────┼─────────────────────┼─────────────────┼─────────┘
            │                     │                 │
┌───────────▼─────────────────────▼─────────────────▼─────────┐
│                   プレゼンテーション層                       │
├─────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────────┐  │
│ │              Streamlit/Gradio UI フレームワーク         │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────┐ │  │
│ │ │ ホーム画面 │ │ 入力画面  │ │ 編集画面  │ │結果表示画面 │ │  │
│ │ └──────────┘ └──────────┘ └──────────┘ └────────────┘ │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ ┌──────────────────────┐  ┌─────────────────────────┐  │  │
│ │ │   共通UIコンポーネント  │  │ アクセシビリティサポート │  │  │
│ │ └──────────────────────┘  └─────────────────────────┘  │  │
│ └────────────────────────────────────────────────────────┘  │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────┐
│                   アプリケーション層                         │
├─────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────────┐  │
│ │               コアシステム制御部 (コントローラ)          │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ ┌──────────────┐ ┌───────────┐ ┌────────────────────┐ │  │
│ │ │ ルーティング管理 │ │ セッション │ │ 入力バリデーション │ │  │
│ │ └──────────────┘ └───────────┘ └────────────────────┘ │  │
│ └────────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌────────────────────────────────────────────────────────┐  │
│ │                ビジネスロジック層                       │  │
│ ├────────────────────────────────────────────────────────┤  │
│ │ ┌──────────────┐ ┌───────────┐ ┌────────────────────┐ │  │
│ │ │プログラム生成   │ │HTML生成   │ │ データ分析・変換   │ │  │
│ │ │サービス        │ │サービス   │ │ サービス          │ │  │
│ │ └──────────────┘ └───────────┘ └────────────────────┘ │  │
│ └────────────────────────────────────────────────────────┘  │
└───────────┬─────────────────────┬─────────────────────┬─────┘
            │                     │                     │
┌───────────▼─────────────────────▼─────────────────────▼─────┐
│                   インテグレーション層                       │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────────────┐ ┌────────────────┐ ┌────────────────┐  │
│ │  AIエージェント   │ │ 外部APIアダプタ  │ │ ストレージ     │  │
│ │  インターフェース │ │                │ │ インターフェース │  │
│ └────────┬─────────┘ └───────┬────────┘ └────────┬───────┘  │
└──────────┼───────────────────┼────────────────────┼──────────┘
           │                   │                    │
┌──────────▼───────┐    ┌──────▼───────┐    ┌──────▼───────────┐
│  AIサービス層     │    │  外部サービス  │    │  データ層        │
├──────────────────┤    ├──────────────┤    ├──────────────────┤
│ ┌──────────────┐ │    │ ┌──────────┐ │    │ ┌──────────────┐ │
│ │ LangChain    │ │    │ │ SMTP     │ │    │ │ 設定ストア   │ │
│ └──────────────┘ │    │ └──────────┘ │    │ │(JSON/YAML)   │ │
│ ┌──────────────┐ │    │ ┌──────────┐ │    │ └──────────────┘ │
│ │ Ollama      │ │    │ │ 静的ホスト│ │    │ ┌──────────────┐ │
│ │(DeepSeek等) │ │    │ │ サービス  │ │    │ │ユーザーデータ │ │
│ └──────────────┘ │    │ └──────────┘ │    │ │(SQLite/PostgreSQL)│
│ ┌──────────────┐ │    │ ┌──────────┐ │    │ └──────────────┘ │
│ │ Vosk/Espeak  │ │    │ │ OSSツール │ │    │ ┌──────────────┐ │
│ └──────────────┘ │    │ └──────────┘ │    │ │ RAG DB       │ │
│ ┌──────────────┐ │    │              │    │ │(Chroma/FAISS)│ │
│ │ 知識ベース検索 │ │    │              │    │ └──────────────┘ │
│ └──────────────┘ │    │              │    │ ┌──────────────┐ │
│                  │    │              │    │ │ ファイルストア │ │
│                  │    │              │    │ └──────────────┘ │
└──────────────────┘    └──────────────┘    └──────────────────┘
```

## 2. 大規模システムの技術スタック

### 2.1 フロントエンド（UI）
- **Streamlit** または **Gradio** をベースとした拡張可能なコンポーネントシステム
  - 独自UIコンポーネントライブラリ
  - コンポーネント間通信メカニズム
  - レスポンシブUI対応
  - テーマ管理システム
- **アクセシビリティフレームワーク**
  - WCAG 2.1 AAレベル対応
  - スクリーンリーダー対応
  - キーボードナビゲーション

### 2.2 バックエンド（サーバー）
- **Python** + **FastAPI**：スケーラブルなバックエンド構成
- **マイクロサービスアーキテクチャ**（オプション）
  - サービスごとに独立したAPIエンドポイント
  - サービス間通信（REST/gRPC）
- **非同期処理フレームワーク**
  - AsyncIO / Celeryによるタスク管理
  - 長時間処理のキュー化と状態管理

### 2.3 AIサービス層
- **LangChain** + **LlamaIndex**：エージェントオーケストレーション
- **Ollama**：ローカルでDeepSeek、Llama等のOSSモデルを実行
- **モデル抽象化レイヤー**：複数のローカルAIモデルを統一インターフェースで管理
- **プロンプトエンジニアリングシステム**：テンプレート、バージョニング、A/Bテスト
- **リソース管理システム**：効率的なモデル利用とメモリ管理
- **AIエージェント進行モード**：
  - 全自動型進行モード（Auto-GPT的アプローチ）
  - 対話型進行モード（LangChainベースのアプローチ）
  - モード切替・ハイブリッド機能

### 2.4 データマネジメント
- **データアクセスレイヤー**：ORMまたはリポジトリパターン
- **永続化**：
  - PostgreSQL：ユーザーデータ、履歴、監査ログ
  - Redis：セッション、キャッシュ
  - オブジェクトストレージ：アップロードファイル、生成物
- **データバージョニング**：設定・テンプレートの履歴管理

### 2.5 インフラストラクチャ
- **Docker Compose**：コンテナオーケストレーション（軽量版）
- **GitHub Actions**：オープンソースのCI/CD
- **Prometheus** + **Grafana**：オープンソースの監視ツール
- **自己ホスティングログ**：EFK (Elasticsearch, Fluentd, Kibana)スタック

## 3. モジュール構成 (パッケージ構造)

### 3.1 ルートレベルパッケージ
```
support_system/
│
├── api/                 # FastAPIルート(必要な場合)
├── core/                # コアシステム、共通機能
├── config/              # 設定ファイル、読み込み処理
├── data/                # データアクセス、モデル定義
├── services/            # ビジネスロジック、AIサービス
├── ui/                  # Streamlit/Gradio UI関連
├── utils/               # ユーティリティ、ヘルパー関数
├── tests/               # テストコード
├── docs/                # ドキュメント
└── scripts/             # デプロイ、管理スクリプト
```

### 3.2 主要モジュール詳細構造
```
core/
├── __init__.py
├── app.py               # アプリケーションエントリーポイント
├── settings.py          # グローバル設定、環境変数
├── exceptions.py        # カスタム例外
├── auth/                # 認証・認可（必要な場合）
├── events/              # イベントシステム
├── logging/             # ロギング設定
└── middleware/          # ミドルウェアコンポーネント

services/
├── __init__.py
├── ai/                  # AIサービス統合
│   ├── __init__.py
│   ├── agent.py         # エージェントオーケストレーション
│   ├── agent_modes/     # エージェント進行モード
│   │   ├── __init__.py
│   │   ├── auto_mode.py # 全自動型進行モード（Auto-GPT的）
│   │   ├── dialog_mode.py # 対話型進行モード（LangChainベース）
│   │   └── mode_manager.py # モード切替・ハイブリッド制御
│   ├── llm.py           # LLM抽象化レイヤー
│   ├── embeddings.py    # 埋め込み生成
│   ├── rag.py           # RAG検索
│   └── prompts/         # プロンプトテンプレート管理
├── program_generator/   # プログラム生成サービス
│   ├── __init__.py
│   ├── base.py          # 基底クラス・共通機能
│   ├── python/          # Python生成
│   ├── javascript/      # JavaScript生成
│   └── templates/       # コードテンプレート
├── webpage_generator/   # Webページ生成サービス
│   ├── __init__.py
│   ├── base.py          # 基底クラス・共通機能
│   ├── components/      # HTML/CSS/JS生成コンポーネント
│   └── templates/       # Webページテンプレート
└── common/              # 共通サービス機能
    ├── __init__.py
    ├── storage.py       # 保存・読み込み
    ├── publishing.py    # 公開機能
    └── preview.py       # プレビュー機能

data/
├── __init__.py
├── models/              # データモデル定義
│   ├── __init__.py
│   ├── base.py          # 基底モデル
│   ├── job.py           # 仕事種類モデル
│   ├── question.py      # 質問項目モデル
│   ├── user.py          # ユーザーモデル（必要時）
│   └── output.py        # 出力結果モデル
├── repositories/        # データアクセス層
│   ├── __init__.py
│   ├── job_repo.py      # 仕事種類リポジトリ
│   ├── question_repo.py # 質問項目リポジトリ
│   └── output_repo.py   # 出力結果リポジトリ
├── storage/             # ファイル保存
│   ├── __init__.py
│   ├── local.py         # ローカルファイル保存
│   └── cloud.py         # クラウド保存（オプション）
└── cache/               # キャッシュ管理
    ├── __init__.py
    └── memory.py        # インメモリ/Redis等キャッシュ

ui/
├── __init__.py
├── app.py               # メインUIアプリ
├── state.py             # UIセッション状態管理
├── theme.py             # テーマ設定
├── components/          # 再利用可能UIコンポーネント
│   ├── __init__.py
│   ├── buttons.py       # ボタン類
│   ├── forms.py         # 入力フォーム
│   ├── preview.py       # プレビューコンポーネント
│   └── accessibility.py # アクセシビリティツール
└── pages/               # 画面定義
    ├── __init__.py
    ├── home.py          # ホーム画面
    ├── job_selection.py # 仕事選択画面
    ├── question.py      # 質問画面
    ├── preview.py       # プレビュー画面
    └── output.py        # 出力画面
```

## 4. データフロー・状態管理

### 4.1 リクエスト処理フロー
1. UIレイヤーがユーザー入力を受け取る
2. 入力バリデーションを行い、コントローラに転送
3. コントローラがサービスレイヤーを呼び出す
4. サービスレイヤーがビジネスロジックを実行
   - 設定ファイルをロード（データアクセスレイヤー経由）
   - AIサービスとの連携（必要に応じて）
   - 結果の生成と検証
5. レスポンスをUIレイヤーに返す
6. UIレイヤーが結果を表示

### 4.2 状態管理戦略
- **分散セッション管理**
  - Redis/Memcachedによるセッションデータ共有
  - セッション有効期限と自動クリーンアップ
- **状態遷移管理**
  - 明示的な状態マシン定義
  - 画面間データの整合性保証

### 4.3 キャッシュ戦略
- **多層キャッシュ**
  - インメモリキャッシュ（高頻度アクセス）
  - Redisキャッシュ（共有データ）
  - ファイルキャッシュ（大容量データ）
- **キャッシュ無効化ポリシー**
  - 時間ベース（TTL）
  - イベント駆動（データ更新時）

## 5. スケーラビリティ・パフォーマンス設計

### 5.1 水平スケーリング
- **ステートレス設計**：複数インスタンス間の状態共有を最小限に
- **ロードバランシング**：トラフィックの分散
- **サービス分離**：独立したスケーリングが可能な構成

### 5.2 パフォーマンス最適化
- **非同期処理**：長時間タスクのバックグラウンド処理
- **バッチ処理**：データ集約・分析の効率化
- **段階的読み込み**：必要なデータのみ初期ロード、残りは必要時に取得

### 5.3 リソース管理
- **コネクションプール**：データベース接続の効率化
- **リソース制限**：ユーザー/セッションごとの制限設定
- **グレースフルデグラデーション**：一部機能が利用できなくても動作継続

## 6. システム運用・保守設計

### 6.1 デプロイメントパイプライン
- **環境分離**：開発・ステージング・本番環境
- **Infrastructure as Code**：Terraform/Ansibleによる環境定義
- **ブルー/グリーンデプロイメント**：無停止更新

### 6.2 監視・アラート
- **ヘルスチェック**：各サービスコンポーネントの状態監視
- **パフォーマンスメトリクス**：処理時間、リソース使用率、エラー率
- **ユーザー体験メトリクス**：ページ読み込み時間、完了率

### 6.3 バックアップ・リカバリ
- **定期バックアップ**：データおよび設定の自動バックアップ
- **ポイントインタイムリカバリ**：特定時点への復元機能
- **障害復旧計画**：各種障害シナリオへの対応手順

## 7. セキュリティ設計

### 7.1 データ保護
- **暗号化**：保存データ・通信の暗号化
- **データ分類**：機密レベルに応じた取り扱い
- **アクセス制御**：最小権限の原則

### 7.2 認証・認可
- **多要素認証**（オプション）
- **ロールベースアクセス制御**
- **セッションセキュリティ**：有効期限、盗難対策

### 7.3 監査・コンプライアンス
- **アクティビティログ**：ユーザー操作、システム変更の記録
- **脆弱性スキャン**：定期的なセキュリティテスト

---

この拡張システム構成図は、何十万行規模の大規模システムに対応できる堅牢なアーキテクチャを提供します。モジュール化、層分離、スケーラビリティを重視した設計により、機能拡張や保守、性能最適化が容易になります。
