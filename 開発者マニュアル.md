# 開発者マニュアル

## 1. 開発環境構築

### 1.1 必要なツール・ソフトウェア
- Python 3.9以上
- Git
- Visual Studio Code（推奨）または他のエディタ
- Docker（オプション、環境の統一に推奨）

### 1.2 ライブラリ・依存関係
```
streamlit==1.24.0
langchain==0.0.267
openai==0.27.8
chromadb==0.4.6
pydantic==1.10.8
python-dotenv==1.0.0
pillow==9.5.0
whisper==1.1.10
```

### 1.3 環境構築手順
1. リポジトリのクローン
```bash
git clone https://github.com/example/support-system.git
cd support-system
```

2. 仮想環境の作成と有効化
```bash
python -m venv venv
# Windowsの場合
venv\Scripts\activate
# Mac/Linuxの場合
source venv/bin/activate
```

3. 依存ライブラリのインストール
```bash
pip install -r requirements.txt
```

4. 環境変数の設定
`.env.example`ファイルをコピーして`.env`を作成し、必要なAPIキーなどを設定します。
```bash
cp .env.example .env
# .envファイルを編集してAPIキーなどを設定
```

5. システムの起動
```bash
streamlit run app.py
```

## 2. プロジェクト構造

### 2.1 ディレクトリ構成
```
support-system/
├── app.py                 # メインアプリケーション
├── requirements.txt       # 依存ライブラリ一覧
├── .env                   # 環境変数（Gitで管理しない）
├── README.md              # プロジェクト概要
├── docs/                  # ドキュメント
│   ├── 要件定義書.md
│   ├── 仕様書.md
│   └── ...
├── config/               # 設定ファイル
│   ├── job_types.json    # 仕事種類の定義
│   ├── questions.json    # 質問項目の定義
│   └── ui_config.json    # UI設定
├── modules/              # 機能モジュール
│   ├── __init__.py
│   ├── program_generator/   # プログラム生成機能
│   │   ├── __init__.py
│   │   ├── image_classifier.py
│   │   └── ...
│   ├── webpage_generator/   # ホームページ生成機能
│   │   ├── __init__.py
│   │   ├── store_page.py
│   │   └── ...
│   └── utils/              # ユーティリティ
│       ├── __init__.py
│       ├── file_handler.py
│       └── ...
├── ui/                    # UI関連
│   ├── __init__.py
│   ├── pages/             # 画面ごとのコード
│   └── components/        # 共通コンポーネント
└── tests/                 # テストコード
    ├── __init__.py
    └── ...
```

### 2.2 主要モジュールの説明

#### 2.2.1 app.py
アプリケーションのエントリーポイント。Streamlitの初期化とセッション管理を担当。

#### 2.2.2 modules/
実際の処理を行う機能モジュール群。以下のサブモジュールがあります。

- `program_generator/`: プログラム生成機能
- `webpage_generator/`: ホームページ生成機能
- `utils/`: ユーティリティ機能（ファイル操作、AIとの連携など）

#### 2.2.3 config/
設定ファイル群。仕事の種類や質問項目など、システムの動作を制御する設定を格納。

## 3. 拡張・修正方法

### 3.1 新しい仕事種類の追加方法
1. `config/job_types.json`に新しい仕事種類を追加
```json
{
  "job_types": [
    {
      "id": "data_visualization",
      "name": "データの可視化",
      "description": "データをグラフやチャートで表示するプログラム",
      "module": "program_generator.data_visualizer",
      "questions": ["data_source", "chart_type", "color_theme"]
    }
  ]
}
```

2. 必要な質問項目を`config/questions.json`に追加
```json
{
  "questions": [
    {
      "id": "chart_type",
      "text": "どんなグラフにしますか？",
      "type": "select",
      "options": ["棒グラフ", "折れ線グラフ", "円グラフ", "散布図"]
    }
  ]
}
```

3. 対応するモジュールを作成
```python
# modules/program_generator/data_visualizer.py
def generate(inputs):
    """
    データ可視化プログラムを生成する
    
    Args:
        inputs (dict): ユーザー入力情報
        
    Returns:
        dict: 生成結果
    """
    # コード生成のロジック
    return {
        "code": generated_code,
        "preview_html": preview,
        "file_name": "data_visualizer.py"
    }
```

### 3.2 UIの修正方法
Streamlit UIは`ui/pages/`ディレクトリ内のファイルで定義されています。例えば、目的選択画面の修正は以下のようになります。

```python
# ui/pages/purpose_selection.py
import streamlit as st
from config.loader import load_job_types

def show():
    """目的選択画面を表示"""
    st.title("どんなものを作りますか？")
    
    # 設定ファイルから仕事種類を読み込む
    job_types = load_job_types()
    
    # 選択肢を表示
    for job in job_types:
        if st.button(job["name"]):
            st.session_state.selected_job = job["id"]
            return "input_screen"  # 次の画面へ
    
    # 自由入力欄
    st.text_input("その他（自由に入力）")
    
    return None  # 画面遷移なし
```

### 3.3 AIモデルの変更方法
AIモデル連携は`modules/utils/ai_connector.py`で管理しています。新しいモデルを追加するには：

1. 必要なライブラリをインストール
```bash
pip install newmodel-package
```

2. コネクタ関数を追加
```python
# modules/utils/ai_connector.py
def connect_to_new_model(prompt, params=None):
    """新しいモデルに接続して応答を生成"""
    from newmodel_package import NewModelAPI
    
    # APIキーを環境変数から取得
    api_key = os.getenv("NEW_MODEL_API_KEY")
    
    # モデルに接続
    client = NewModelAPI(api_key)
    response = client.generate(prompt, **params)
    
    return response.text
```

3. `.env`ファイルにAPIキーを追加
```
NEW_MODEL_API_KEY=your_api_key_here
```

## 4. テスト方法

### 4.1 単体テスト
```bash
# 全てのテストを実行
python -m pytest tests/

# 特定のモジュールのテストのみ実行
python -m pytest tests/test_program_generator.py
```

### 4.2 手動テスト
開発中の機能をテストするには、以下の手順で簡易テスト画面を起動できます。

```bash
streamlit run tests/manual_test.py
```

## 5. デプロイ手順

### 5.1 本番環境の準備
- サーバー：AWS EC2, GCP, Azureなど
- メモリ：最低4GB以上推奨
- ディスク：10GB以上
- ネットワーク：公開アクセス可能なポート設定

### 5.2 Dockerを使ったデプロイ
```bash
# Dockerイメージのビルド
docker build -t support-system:latest .

# コンテナの起動
docker run -d -p 8501:8501 --name support-system \
  --env-file .env.prod \
  support-system:latest
```

### 5.3 サーバー直接デプロイ
```bash
# リポジトリのクローン
git clone https://github.com/example/support-system.git
cd support-system

# 依存関係のインストール
pip install -r requirements.txt

# 本番用の環境変数設定
cp .env.example .env.prod
# .env.prodを編集

# アプリケーションの起動
streamlit run app.py --server.port 8501 --server.address 0.0.0.0
```

## 6. トラブルシューティング

### 6.1 よくあるエラーと解決方法
- **ライブラリ関連のエラー**
  ```
  ModuleNotFoundError: No module named 'xxx'
  ```
  解決: `pip install xxx` で不足ライブラリをインストール
  
- **API連携エラー**
  ```
  ApiError: Authentication failed
  ```
  解決: `.env`ファイルのAPIキーを確認

- **メモリ不足エラー**
  ```
  MemoryError: ...
  ```
  解決: サーバーのメモリを増やす、または大きなファイル処理を分割

### 6.2 ログの確認方法
ログファイルは`logs/`ディレクトリに保存されます。エラーが発生した場合、以下のファイルを確認してください。

- `logs/app.log`: アプリケーション全体のログ
- `logs/ai_requests.log`: AI APIリクエストのログ

ログレベルは`.env`ファイルの`LOG_LEVEL`で調整できます。

---

このマニュアルは継続的に更新されます。質問や改善提案は開発チームまでお知らせください。
